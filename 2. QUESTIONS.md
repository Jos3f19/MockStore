# PlacetoPay Integration - Conceptual Questions

Based on the official PlacetoPay documentation I'm going to answer the questions asked in the document received via email:
- WebCheckout: https://docs.placetopay.dev/en/checkout/
- API Gateway: https://docs.placetopay.dev/en/gateway/

---

## 1. What is the RequestId, what is it used for, and in which cases is it repeated?

**RequestId** is a **unique identifier** assigned by PlacetoPay to each payment session when it's created through WebCheckout.

### What is it used for?:
- Identifies and tracks a specific payment session throughout its lifecycle
- Used to create, query and cancel a session through their respective endpoints 
(`POST /api/session`)
(`POST /api/session/:requestId`)
(`POST /api/session/:requestId/cancel`)

- Received in notifications to identify which payment session the notification refers to
- Links a internal payment record with PlacetoPay's transaction records

### When is it repeated?:
- The `requestId` is **NOT repeated** for different sessions - each new session gets a unique identifier
- However, the **same `requestId`** is used to:
  - Query the same session multiple times
  - Cancel that specific session
  - Receive notifications about that specific session

### Special case for recurring payments:
For recurring payments that happen after the initial session, the `requestId` field is **NOT present** in notifications because this payment is generated automatically and is not associated with a session created by the merchant. It is an independent transaction..

> **Sources:**
> - https://docs.placetopay.dev/en/checkout/api/reference/session/
> - https://docs.placetopay.dev/en/checkout/notification/

---

## 2. What are the possible transaction states? Explain the meaning of each one.

| State | Meaning |
|-------|---------|
| **PENDING** | Initial state or waiting state. Occurs when: (1) The session has just been created and is waiting for user actions, (2) There are rejected transactions but allows the user to make new attempts, or (3) There is a transaction pending validation. So, basically, it is a waiting state and indicates that the process is not yet completed. |
| **APPROVED** | The transaction(s) have been approved and the process has been successfully completed. This is a **final state**. |
| **REJECTED** | The session was canceled by the user, or the session reached its expiration time without an approved payment. This is a **final state**. |
| **APPROVED_PARTIAL** | *(For partial payment sessions only)* The user has paid part of the total requested amount, but another part is still pending or has failed. The user can still complete the payment with other transactions. |
| **PARTIAL_EXPIRED** | *(For partial payment sessions only)* The user has only paid a portion of the total amount and the time available to complete the payment has ended. The process cannot be completed. This is a **final state**. |

> **Sources:**
> - https://docs.placetopay.dev/en/checkout/how-checkout-works/#checkout-session-states

---

## 3. What is preauthorization and how would it work for a merchant? Provide an example.

**Preauthorization** is a transaction type that allows you to **reserve (hold) funds** on a customer's credit card **without immediately charging** them. The final charge amount can be adjusted before capturing the funds. This is useful when the final charge amount is not known upfrontâ€”common in scenarios like hospitality, mobility, or equipment rentals.

### The preauthorization flow has 3 steps:

1. **Check-in**: Reserve a specific amount on the customer's card without immediate capture
2. **Reauthorization** *(optional)*: Adjust the reserved amount if the expected charge changes
3. **Checkout**: Capture the final amount or release the reservation

### Example - Hotel Booking:

A hotel uses preauthorization for guest stays:

**Step 1 - Check-in (Day 1):** Guest arrives, hotel creates a preauthorization for $500 (estimated stay + incidentals)

**Step 2 - Reauthorization (Day 3):** Guest uses minibar and room service, hotel adjusts the hold to $650

**Step 3 - Checkout (Day 5):** Guest checks out, final bill is $580, hotel captures that amount

This is ideal for **hospitality, mobility, equipment rentals**, or any scenario where the final charge amount is not known upfront.

> **Sources:**
> - https://docs.placetopay.dev/en/payments/preauthorization/

---

## 4. Explain the differences between subscription-based charging and recurring charging.

| Aspect | **Subscription** | **Recurring Payment** |
|--------|------------------|----------------------|
| **Purpose** | Tokenize and securely store a payment method for future merchant-controlled charges | Automatic periodic charges managed by PlacetoPay |
| **Who controls charges** | The **merchant** decides when and how much to charge | **PlacetoPay** automatically charges based on predefined rules |
| **Flexibility** | Full control - charge any amount at any time | Fixed amount and interval defined at creation |
| **Payment timing** | Merchant initiates each charge via the Collect API | Automatic based on `periodicity` and `interval` |
| **Use case** | Variable amounts, on-demand charges, custom billing cycles | Fixed subscriptions (monthly gym membership, streaming service) |
| **Configuration** | The `payment.recurring` property must be sent with the `Recurrence` structure | It is necessary to send the `subscription` structure in the `CreateSessionRequest` |

### Subscription JSON Example:
```json
{
    CreateSessionRequest...
    "subscription": {
        "reference": "3110",
        "description": "A trial subscription"
    },
    ...
}
```
After tokenization, the merchant uses the token to charge whenever needed using the **Collect** service.

### Recurring Payment JSON Example:
```json
{
    CreateSessionRequest...
    "payment": {
        "reference": "PAY_ABC_1287",
        "description": "Payment by Placetopay",
        "amount": {
            "currency": "USD",
            "total": 1000
        },
        "recurring": {
            "periodicity": "D",
            "interval": "1",
            "nextPayment": "2024-08-24",
            "maxPeriods": 12,
            "dueDate ": "2024-09-24",
            "notificationUrl ": "https://merchanturl.com/notify"
        },
    }
    ...
}
```

> **Sources:**
> - https://docs.placetopay.dev/en/checkout/create-session/#subscription
> - https://docs.placetopay.dev/en/checkout/create-session/#recurring-payment
> - https://docs.placetopay.dev/en/checkout/create-session/#collect-payment
> - https://docs.placetopay.dev/en/account-validator/api/session/#create-a-session

---

## 5. What is the difference between API Gateway and WebCheckout?

| Aspect | **WebCheckout** | **API Gateway** |
|--------|-----------------|-----------------|
| **User Interface** | PlacetoPay provides a **hosted payment page** (with appareance personalization) where users enter card data | **No UI** - merchant must build their own interface to capture card data |
| **Data handling** | Sensitive card data is entered directly on PlacetoPay's secure page | Merchant captures and transmits cardholder information including sensitive data.|
| **PCI Compliance** | PCI guidelines already implemented to ensure security in the capture and processing of card information. - PlacetoPay handles sensitive data | Full PCI compliance required for the merchant |
| **Integration complexity** | Simpler - redirect users to a URL | More complex - requires handling sensitive data securely |
| **Control** | Less control over UI/UX | Full control over the payment experience |
| **Recommended for** | Most e-commerce integrations | Specialized cases (see below) |

### Examples where may be required to use API Gateway:
- Recurring charges from a proprietary database
- Proprietary mobile interfaces (not HTML-based)
- Integration where sensitive data entry is not done directly by the cardholder

> **Sources:**
> - https://docs.placetopay.dev/en/checkout/
> - https://docs.placetopay.dev/en/gateway/

---

## 6. What is dispersion used for in a merchant context?

**Dispersion** (also called "split payment") is used to **divide a single payment across multiple recipients/destinations** in a single transaction. In order to use the dispersion payment, it's necessary to pass the `payment.dispersion` property which contains an array of `DispersionRequests`.

### Use cases:
- **Marketplaces**: Split payment between the platform and individual sellers
- **Travel agencies**: Split between the agency and airline

### How it works JSON EXAMPLE:
```json
{
    CreateSessionRequest...
    "payment": {
        "reference": "PAY_ABC_1287",
        "description": "Payment by Placetopay",
        "amount": {
            "currency": "USD",
            "total": 1000
        },
        "dispersion": [
            {
                "amount": {
                    "total": 700,
                    "currency": "USD"
                },
                "agreement": 30,
                "agreementType": "AIRLINE"
            },
            {
                "amount": {
                    "total": 300,
                    "currency": "USD"
                },
                "agreementType": "MERCHANT"
            }
        ],
    }
    ...
}
```

### NOTE:
To make use of the dispersion payment functionality it is important to know the identifier of the agreement (agreement) to which the payment is directed. If no agreement value is added, the payment method configured on the site of the session will be taken by default, it is also necessary to indicate the type of agreement (aggrementType), in this case MERCHANT or AIRLINE.

Additionally, the payment can be divided into different registered agreements, it also allows each part of the transaction to be processed by different providers.

### Conditions:

- Partial payments and preauthorization are NOT allowed with dispersion
- Total of all dispersions must equal the total payment amount
- All currencies must match

### Example based on the previous JSON:
A customer buys a $1,000 flight package. The payment is automatically split: $700 goes to the airline and $300 stays with the travel agency.

> **Sources:**
> - https://docs.placetopay.dev/en/checkout/create-session/#dispersion-payment

---

## 7. What is the notification used for?

The **Notification** is an **HTTP callback** sent by PlacetoPay to the merchant's server when a session reaches a final status.

### Purpose:
- Inform the merchant that a payment session has been completed
- Allow the merchant to update their system with the transaction result
- Provide real-time updates without constant polling

### Notification structure:
```json
{
  "status": {
    "status": "APPROVED",
    "reason": "00",
    "message": "Transaction approved",
    "date": "2019-01-01T12:00:00-05:00"
  },
  "requestId": 1234,
  "reference": "TEST_123424",
  "signature": "sha256:a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s"
}
```

### Merchant's Considerations:
1. **Validate the signature** using: `SHA-256` The formula used to verify the signature is `SHA-256(requestId + status.status + status.date + yoursecretKey)`
2. Notifications are sent **only once** - no retries if it fails
3. The respond for the webhook must be a **HTTP 2xx** status and must be given as soon as possible
4. Server needs to support HTTPS with TLS 1.2 or 1.3 to maintain a high level of security in notifications.
5. Despite duplicate notifications are very rare, as a merchant, it's important to handle these events appropriately to ensure the integrity of the transaction processing.
6. **Query the session** after receiving notification to get full transaction details

### For recurring payments:
Notifications are slightly different - they don't include `requestId` but include `internalReference` and a `recurring` object with retry information.

> **Sources:**
> - https://docs.placetopay.dev/en/checkout/notification/